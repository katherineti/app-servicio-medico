<div mat-dialog-title class="center-img">
    <img
        src="./assets/logo-ciip.png"
        class="m-2"
        alt="logo ciip"
        width="150"
    />
</div>

<mat-drawer-container class="example-container" autosize>
    <mat-drawer 
        class="example-sidenav" 
        mode="side" 
        [opened]="isSidenavOpen"
        [ngClass]="{'hide-on-mobile': true}">
        <mat-list role="list">
            <mat-list-item 
                role="listitem" 
                (click)="changeSection('title')" 
                [class.active]="activeSection === 'title'">
                Título
            </mat-list-item>
            <mat-list-item 
                role="listitem" 
                (click)="changeSection('summary')" 
                [class.active]="activeSection === 'summary'">
                Resumen
            </mat-list-item>
            <mat-list-item 
                role="listitem" 
                (click)="changeSection('conclusions')" 
                [class.active]="activeSection === 'conclusions'">
                Conclusiones
            </mat-list-item>
        </mat-list>
    </mat-drawer>
    
    <div class="example-sidenav-content">
        @if (this.token) {
            <div class="content-container">
                <div class="scrollable-content">
                    <form [formGroup]="reportFormGroup" #f="ngForm">
                        
                        @if (activeSection === 'title') {
                        <div class="form-section">
                            <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Título</mat-label>
                                <input
                                    matInput
                                    placeholder="Título"
                                    formControlName="title"
                                    required="true"
                                    type="text"
                                />
                                <mat-error *ngIf="reportFormGroup.controls['title'].hasError('required')">
                                    El título es requerido
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('title')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Destinatario</mat-label>
                                <input
                                    matInput
                                    placeholder="Destinatario"
                                    formControlName="receiver"
                                    required="true"
                                    type="text"
                                />
                                <mat-error *ngIf="reportFormGroup.controls['receiver'].hasError('required')">
                                    El destinatario es requerido
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('receiver')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field>

<!--                             <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Auditor</mat-label>
                                <mat-select
                                    placeholder="Auditor"
                                    formControlName="auditor"
                                    required="true"
                                    readonly
                                >
                                    <mat-option [value]="null">{{
                                        'Ninguno' | titlecase
                                    }}</mat-option>
                                    <mat-option [value]="this.token.sub">{{
                                        user_name | titlecase
                                    }}</mat-option>
                                </mat-select>
                                <mat-error *ngIf="reportFormGroup.controls['auditor'].hasError('required')">
                                    El auditor es requerido
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('auditor')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field> -->
                          <mat-form-field appearance="outline" class="example-full-width">
                            <mat-label>Auditor principal</mat-label>
                            
                            <input type="text"
                                matInput
                                placeholder="Buscar auditor principal..."
                                formControlName="auditor"
                                [matAutocomplete]="auto"
                                required="true"
                                readonly="true" 
                            />

                            <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete" [displayWith]="displayFn"> </mat-autocomplete>

                            <mat-error *ngIf="reportFormGroup.controls['auditor'].hasError('required')">
                                El auditor es requerido
                            </mat-error>
                            <mat-error *ngIf="reportFormGroup.get('auditor')?.hasError('maxlength')">
                                Máximo de 50 caracteres.
                            </mat-error>

                            <button 
                            mat-icon-button 
                            matSuffix 
                            type="button" 
                             (click)="toggleAdditionalAuditorForm()"
                            matTooltip="Agregar auditores"
                        >
                            <mat-icon>person_add</mat-icon> 
                        </button>
                        </mat-form-field>

                        <!--  Auditores adicionales -->
                        @if (showAddAuditorForm) {
                            <app-auditor-multi-select class="example-full-width"
                                formControlName="additionalAuditors"
                                label="Auditores adicionales"
                                placeholder="Buscar auditores adicionales..."
                                [disabledFieldAdditionalAuditors]="!this.edit? true : false"
                                (auditorsChange)="onAdditionalAuditorsChange($event)"
                               >
                            </app-auditor-multi-select>
    
                            <!-- Auditores adicionales seleccionados -->
<!--                             @if (selectedAdditionalAuditors.length > 0) {
                            <div class="selected-auditors-summary">
                                <h4>Auditores Adicionales Seleccionados ({{selectedAdditionalAuditors.length}}):</h4>
                                <br>
                                <div class="auditor-chips">
                                    @for (auditor of selectedAdditionalAuditors; track auditor.id) {
                                    <mat-chip class="auditor-chip p-y-20">
                                        <mat-icon matChipAvatar>person</mat-icon>
                                        {{auditor.name | titlecase}}
                                        <!-- <span class="auditor-email-chip">{{auditor.email}}</span> - ->
                                        <br><span class="auditor-email-chip">{{auditor.email}}</span>
                                    </mat-chip>
                                    }
                                </div>
                            </div>
                            }
                            <br> <br> -->
                        }


                        </div>
                        }

                        @if (activeSection === 'summary') {
                        <div class="form-section">
                            <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Objetivo</mat-label>
                                <textarea
                                    matInput
                                    placeholder="Objetivo"
                                    formControlName="summary_objective"
                                    required="true"
                                    rows="4"
                                ></textarea>
                                <mat-error *ngIf="reportFormGroup.controls['summary_objective'].hasError('required')">
                                    El objetivo es requerido
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('summary_objective')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Alcance</mat-label>
                                <textarea
                                    matInput
                                    placeholder="Alcance"
                                    formControlName="summary_scope"
                                    required="true"
                                    rows="4"
                                ></textarea>
                                <mat-error *ngIf="reportFormGroup.controls['summary_scope'].hasError('required')">
                                    El alcance es requerido
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('summary_scope')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Metodología</mat-label>
                                <textarea
                                    matInput
                                    placeholder="Metodología"
                                    formControlName="summary_methodology"
                                    required="true"
                                    rows="4"
                                ></textarea>
                                <mat-error *ngIf="reportFormGroup.controls['summary_methodology'].hasError('required')">
                                    La metodología es requerida
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('summary_methodology')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Conclusión y Observación</mat-label>
                                <textarea
                                    matInput
                                    placeholder="Conclusión y Observación"
                                    formControlName="summary_conclusionAndObservation"
                                    required="true"
                                    rows="4"
                                ></textarea>
                                <mat-error *ngIf="reportFormGroup.controls['summary_conclusionAndObservation'].hasError('required')">
                                    La conclusión y observación es requerida
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('summary_conclusionAndObservation')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field>
                        </div>
                        }

                        @if (activeSection === 'conclusions') {
                        <div class="form-section">
                            <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Introducción</mat-label>
                                <textarea
                                    matInput
                                    placeholder="Introducción"
                                    formControlName="introduction"
                                    required="true"
                                    rows="4"
                                ></textarea>
                                <mat-error *ngIf="reportFormGroup.controls['introduction'].hasError('required')">
                                    La introducción es requerida
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('introduction')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Metodología Detallada</mat-label>
                                <textarea
                                    matInput
                                    placeholder="Metodología Detallada"
                                    formControlName="detailed_methodology"
                                    required="true"
                                    rows="4"
                                ></textarea>
                                <mat-error *ngIf="reportFormGroup.controls['detailed_methodology'].hasError('required')">
                                    La metodología es requerida
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('detailed_methodology')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Hallazgos</mat-label>
                                <textarea
                                    matInput
                                    placeholder="Hallazgos"
                                    formControlName="findings"
                                    required="true"
                                    rows="4"
                                ></textarea>
                                <mat-error *ngIf="reportFormGroup.controls['findings'].hasError('required')">
                                    El hallazgo es requerido
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('findings')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="example-full-width">
                                <mat-label>Conclusiones</mat-label>
                                <textarea
                                    matInput
                                    placeholder="Conclusiones"
                                    formControlName="conclusions"
                                    required="true"
                                    rows="4"
                                ></textarea>
                                <mat-error *ngIf="reportFormGroup.controls['conclusions'].hasError('required')">
                                    La conclusión es requerida
                                </mat-error>
                                <mat-error *ngIf="reportFormGroup.get('conclusions')?.hasError('maxlength')">
                                    Máximo de 50 caracteres.
                                </mat-error>
                            </mat-form-field>

                            <div class="image-upload-container">
                                @if((this.selectedReport.images!=null && !this.edit) || this.edit){
                                    <app-image-upload
                                        [images]="selectedImages"
                                        (imagesChange)="onImagesChange($event)"
                                        [maxImages]="10"
                                        [maxSizeInMB]="5"
                                        [show_uploadImageIcon]="!this.edit?false:true">
                                    </app-image-upload>
                                }
                            </div>
                        </div>
                        }
                    </form>
                </div>

                <!-- Botones de acción fuera del área de scroll -->
                @if (this.edit) {
                <div class="action-buttons">
                    <mat-dialog-actions align="end">
                        <div class="d-flex justify-content-end gap-2">
                            @if (activeSection === 'summary' || activeSection === 'conclusions') {
                                <button
                                    mat-flat-button
                                    class="bg-error"
                                    (click)="changeSection(activeSection === 'summary' ? 'title' : 'summary')"
                                >
                                    <mat-icon>arrow_back</mat-icon> Regresar
                                </button>
                            }

                            <button
                                mat-flat-button
                                class="bg-error"
                                (click)="cancel()"
                            >
                                Cancelar
                            </button>

                            @if (activeSection === 'title') {
                                <button
                                    mat-flat-button
                                    color="primary"
                                    (click)="save()"
                                >
                                    Siguiente <mat-icon>arrow_forward</mat-icon>
                                </button>
                            }

                            @if (activeSection === 'summary') {
                                <button
                                    mat-flat-button
                                    color="primary"
                                    (click)="updateReport()"
                                >
                                    Siguiente <mat-icon>arrow_forward</mat-icon>
                                </button>
                            }

                            @if (activeSection === 'conclusions') {
                                <button
                                    mat-flat-button
                                    color="primary"
                                    (click)="updateReport()"
                                >
                                    Guardar
                                </button>
                            }
                        </div>
                    </mat-dialog-actions>
                </div>
                }
            </div>
        }
    </div>
</mat-drawer-container>